---
title: "pacoExample_analysis"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require(pacman)) install.packages("pacman"); library(pacman)

p_load(tidyverse, ggridges)
p_load_current_gh("FredHasselman/casnet")        # Need for center()
p_load_current_gh("jmbh/mgm")

knitr::opts_chunk$set(echo = TRUE, 
               warning = TRUE,
               error = TRUE,
               cache = TRUE, 
               collapse = TRUE,
               eval = TRUE)
knitr::opts_chunk$set(root.dir = ".")  # Always project root as working directory
knitr::opts_knit$set(root.dir = ".")  # This is needed for some versions of RStudio

esm_data_orig <- read_csv("data/pacoReport180910.csv")

esm_data <- esm_data_orig %>% 
  dplyr::rename(Vapaaehtoisuus = bpns1,
                Kyvykkyys = bpns2,
                Yhteenkuuluvuus = bpns3,
                "Joku toinen" = sdt1,
                Tilanne = sdt2,
                Mielihyvä = sdt3,
                Kiinnostus = sdt4,
                Tärkeys = sdt5,
                Syyllisyys = sdt6) %>%
  dplyr::mutate(day = lubridate::day(responseTime),
                date = lubridate::date(responseTime),
                task = Task,
                task = case_when(stringr::str_detect(task, "reading") ~ "lukeminen",
                                 stringr::str_detect(task, "leverage points") ~ "lukeminen",
                                 stringr::str_detect(task, "email") ~ "lukeminen",
                                 stringr::str_detect(task, "meeting") ~ "tapaaminen",
                                 stringr::str_detect(task, "skype") ~ "tapaaminen",
                                 stringr::str_detect(task, "Skype") ~ "tapaaminen",
                                 stringr::str_detect(task, "network") ~ "data-analyysi",
                                 stringr::str_detect(task, "data") ~ "data-analyysi",
                                 stringr::str_detect(task, "codebook") ~ "data-analyysi",
                                 stringr::str_detect(task, "dynamic complexity") ~ "data-analyysi",
                                 stringr::str_detect(task, "recurrence plots") ~ "data-analyysi",
                                 stringr::str_detect(task, "interpreting data") ~ "data-analyysi",
                                 stringr::str_detect(task, "coding") ~ "data-analyysi",
                                 stringr::str_detect(task, "listening") ~ "esityksen kuunteleminen",
                                 stringr::str_detect(task, "media") ~ "tiedonhaku",
                                 stringr::str_detect(task, "paper") ~ "kirjoittaminen",
                                 stringr::str_detect(task, "longitudinal") ~ "data-analyysi",
                                 !is.na(task) ~ "muu",
                                 TRUE ~ task),
                Perustarpeet = ((Vapaaehtoisuus + Kyvykkyys + Yhteenkuuluvuus) / 3),
                "Sisäinen motivaatio" = (Tärkeys + Kiinnostus + Mielihyvä) / 3,
                "Ulkoinen motivaatio" = (`Joku toinen` + Tilanne + Syyllisyys) / 3,
                Olinpaikka = factor(Location),
                `Muita paikalla` = social,
                User = "pacoMatti",
                Serie = "paco5x") 

pacoData <- esm_data %>%
  dplyr::select(`Joku toinen`:Yhteenkuuluvuus, Perustarpeet:`Ulkoinen motivaatio`, everything()) %>% 
  dplyr::mutate_at(vars(`Joku toinen`:`Ulkoinen motivaatio`), funs(. * (50/7))) %>% 
  tidyr::gather(Field, Value, `Joku toinen`:`Ulkoinen motivaatio`) %>% 
  dplyr::select(User, Date = responseTime, Serie, day, Field, Value) %>% 
  dplyr::mutate(day = lubridate::yday(Date))

tnoData <- readr::read_tsv("data/data.tsv") %>% 
  dplyr::filter(User != "ferry", User != "keegan", User != "test01") 

sdtData <- tnoData %>% dplyr::mutate(Field = case_when(
  stringr::str_detect(Field, pattern = "competen") ~ "Kyvykkyys", # covers "competence" and "competent"
  stringr::str_detect(Field, pattern = "choose_the_way_of_working") ~ "Vapaaehtoisuus",
  stringr::str_detect(Field, pattern = "autonomy") ~ "Vapaaehtoisuus",
  stringr::str_detect(Field, pattern = "important_part_of_a_group") ~ "Yhteenkuuluvuus",
  stringr::str_detect(Field, pattern = "relatedness") ~ "Yhteenkuuluvuus",
  stringr::str_detect(Field, pattern = "guilty_or_anxious") ~ "Syyllisyys",
  stringr::str_detect(Field, pattern = "anxiety_guilt") ~ "Syyllisyys",
  stringr::str_detect(Field, pattern = "important") ~ "Tärkeys",
  stringr::str_detect(Field, pattern = "importance") ~ "Tärkeys",
  stringr::str_detect(Field, pattern = "interesting") ~ "Kiinnostus",
  stringr::str_detect(Field, pattern = "interest") ~ "Kiinnostus",
  stringr::str_detect(Field, pattern = "pleasurable") ~ "Mielihyvä",
  stringr::str_detect(Field, pattern = "pleasure") ~ "Mielihyvä",
  stringr::str_detect(Field, pattern = "someone_else_wants_me_to") ~ "Joku toinen",
  stringr::str_detect(Field, pattern = "for_others") ~ "Joku toinen",
  stringr::str_detect(Field, pattern = "situation_requires") ~ "Tilanne",
  stringr::str_detect(Field, pattern = "required") ~ "Tilanne",
  stringr::str_detect(Field, pattern = "own_question") ~ "Oma kysymys",
  stringr::str_detect(Field, pattern = "your_last_break_ended") ~ "Aikaa tauosta",
  stringr::str_detect(Field, pattern = "time_since_break") ~ "Aikaa tauosta",
  stringr::str_detect(Field, pattern = "satisfaction_work") ~ "Tyytyväisyys työpäivään",
  stringr::str_detect(Field, pattern = "productivity_work") ~ "Tyytyväisyys suoritukseen",
  stringr::str_detect(Field, pattern = "how_satisfied_were_you") ~ "Tyytyväisyys työpäivään",
  stringr::str_detect(Field, pattern = "how_productive_were_you") ~ "Tyytyväisyys suoritukseen",  
  stringr::str_detect(Field, pattern = "strategies") ~ "Tekniikat",
  stringr::str_detect(Field, pattern = "how_well_did_you_sleep") ~ "Unenlaatu",
  stringr::str_detect(Field, pattern = "sleep_quality") ~ "Unenlaatu",
  stringr::str_detect(Field, pattern = "what_task_you_are_working") ~ "Tehtävä",
  Field == "task" ~ "Tehtävä",
  stringr::str_detect(Field, pattern = "add_any_notes_comments") ~ "Kommentit hetkestä",
  stringr::str_detect(Field, pattern = "comments_moment") ~ "Kommentit hetkestä",
  stringr::str_detect(Field, pattern = "additional_information_about_your_day") ~ "Kommentit päivästä",
  stringr::str_detect(Field, pattern = "comments_day") ~ "Kommentit päivästä",
  stringr::str_detect(Field, pattern = "how_many_other_people") ~ "Muita ihmisiä tehtävässä",
  stringr::str_detect(Field, pattern = "others_task") ~ "Muita ihmisiä tehtävässä",
  stringr::str_detect(Field, pattern = "where_are_you_working") ~ "Työskentelypaikka",
  TRUE ~ Field),
  # Field = factor(Field, level = c("Kyvykkyys", "Vapaaehtoisuus", "Yhteenkuuluvuus",
  #                                 "Kiinnostus", "Mielihyvä", "Tärkeys",
  #                                 "Tilanne", "Syyllisyys", "Joku toinen",
  #                                 "Oma kysymys",
  #                                 "Tyytyväisyys työpäivään", "Tyytyväisyys suoritukseen",
  #                                 "Tekniikat", "Unenlaatu", 
  #                                 "Aikaa tauosta", )),
  day = lubridate::yday(tnoData$Date)) %>%
  dplyr::filter(!is.na(Field)) %>%
  tidyr::spread(Field, Value) %>%
  dplyr::mutate_at(vars(Kyvykkyys, Vapaaehtoisuus, Yhteenkuuluvuus, 
                        Tärkeys, Kiinnostus, Mielihyvä,
                        "Joku toinen", Tilanne, Syyllisyys), 
                   funs(as.numeric(.))) %>% 
  dplyr::mutate("Perustarpeet" = (Kyvykkyys + Vapaaehtoisuus + Yhteenkuuluvuus) / 3,
                "Sisäinen motivaatio" = (Tärkeys + Kiinnostus + Mielihyvä) / 3,
                "Ulkoinen motivaatio" = (`Joku toinen` + Tilanne + Syyllisyys) / 3) %>%
  tidyr::gather(key = "Field", value = "Value", -User, -Date, -Serie, -day) %>%
  dplyr::arrange(Date)

# tnoData <- tnoData %>% dplyr::distinct(Date, Field, Value, .keep_all = TRUE) # Remove rows which have the same date, question and value.

allData <- rbind(sdtData, pacoData) %>% dplyr::filter(User == "matti" | User == "Moti05" | User == "pacoMatti") %>%
  dplyr::distinct(Date, Field, Value, .keep_all = TRUE) %>% 
  dplyr::arrange(Date) %>% 
  tidyr::spread(Field, Value)

cohortData <- tnoData %>% 
  dplyr::filter(stringr::str_detect(User, pattern = "Moti"), User != "Moti05")

username <- "Moti05"
# tnoData %>% tidyr::spread(Field, Value) %>% arrange(Date) %>% dplyr::select(User, Date, Serie, contains("productive"), contains("overall"))
```

# Technique use

Mean, SD and range of days from which technique data is available

```{r techniqueDataAvailable}
cohortData %>% 
  tidyr::spread(Field, Value) %>% 
  dplyr::group_by(User) %>% 
  dplyr::select(User, strategies) %>% 
  na.omit(strategies) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::summarise(mean = mean(n), sd = sd(n), rangeFrom = range(n)[1], rangeTo = range(n)[2])

  
```

Number of techniques reported by week since starting the study

```{r}
cohortData %>% 
  tidyr::spread(Field, Value) %>% 
  tidyr::separate(strategies, 
                  into = paste("technique", 1:20, sep = "_"), 
                  sep = ";",
                  extra = "merge") %>% 
  tidyr::gather(techniquePosition, technique, 
                technique_1:technique_20) %>% 
  dplyr::mutate(technique = factor(technique),
                week = lubridate::week(Date)) %>%
  dplyr::mutate(Date = as.Date(Date),
                Today = Sys.Date(),
                Weeks = as.numeric(difftime(Today, Date, units="weeks")) %>% round(., 0)) %>% 
  dplyr::group_by(User, Weeks) %>% 
  dplyr::summarise(n_techniques = sum(!is.na(technique))) %>% 
  dplyr::mutate(label = if_else(Weeks == max(Weeks), as.character(User), NA_character_)) %>% 
  ggplot(aes(y = n_techniques, x = Weeks, fill = User)) +
  geom_line(size = 1.05, alpha = 0.8, aes(colour = User)) +
  geom_point(size = 1.05, alpha = 0.8, aes(colour = User)) +
  ggrepel::geom_text_repel(aes(label = label), # see: https://stackoverflow.com/questions/29357612/plot-labels-at-ends-of-lines
    alpha = 0.5,
    size = 2.5,
    box.padding = 0,
    nudge_x = 1,
    na.rm = TRUE) +
  scale_y_continuous(breaks = seq(from = 0, to = 1000, by = 5)) + 
  scale_colour_viridis_d(end = 0.9) +
  labs(x = "Weeks since start of study", y = "Reported technique use") +
  theme_bw() +
  theme(legend.position = "none") 
```

# Save data for sideR / tileR

```{r}

tnoData %>% 
  dplyr::filter(User == "Moti05") %>% 
  tidyr::spread(Field, Value) %>% 
  dplyr::mutate_at(vars(anxiety_guilt, autonomy, competence, for_others, importance, interest, own_question, pleasure, 
                        productivity_work, satisfaction_work, sleep_quality,
                        relatedness, required, time_since_break), 
                   funs(as.numeric)) %>% 
  dplyr::mutate_at(vars(location, others_task, project_name, task), funs(forcats::as_factor)) %>%
  dplyr::select(anxiety_guilt, autonomy, competence, for_others, importance, interest, own_question, pleasure, 
                        # productivity_work, satisfaction_work, sleep_quality, project_name
                        relatedness, required, time_since_break,
                location, others_task, task) %>% 
  na.omit(.) %>% 
  saveRDS(., "C:/LocalData/hema/git-projects/sideR-master/R/sideR/data/Moti05.rds")

shiny::runApp("C:/LocalData/hema/git-projects/sideR-master/R/sideR/")
```

# Data collection line chart

```{r cumulative-datacollection-linechart}
# tnoData[c(5088), ] 
# 
# tnoData <- tnoData %>% slice(-5088)  
  
# Sys.setlocale("LC_ALL", "English") # For English month names
dateRanges <- data.frame(
  start = seq(as.POSIXct("1900-11-02 19:00:00"), as.POSIXct("2100-11-02 19:00:00"), "1 week"),
  end = seq(as.POSIXct("1900-11-05 05:00:00"), as.POSIXct("2100-11-05 05:00:00"), "1 week"))

dateRanges$startDay <- weekdays(dateRanges$start)
dateRanges$endDay <- weekdays(dateRanges$end)

cohortData %>%
  tidyr::spread(Field, Value) %>%
  dplyr::mutate(day = as.Date(Date)) %>% 
  dplyr::group_by(day, User) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::arrange(day) %>% 
  dplyr::group_by(User) %>% 
  dplyr::mutate(cumsum = cumsum(n),
                label = if_else(day == max(day), as.character(User), NA_character_)) %>% # see: https://stackoverflow.com/questions/21818427/how-to-add-a-cumulative-column-to-an-r-dataframe-using-dplyr
  ggplot(aes(y = cumsum - 1, x = day, fill = User)) +
  geom_line(size = 1.05, alpha = 0.8, aes(colour = User)) +
  # bdscale::scale_x_bd(business.dates = bdscale::nyse) + # doesn't work due to infinite values from transformation (see: https://github.com/dvmlls/bdscale)
  geom_rect(data = dateRanges, 
            aes(xmin = as.Date(start), xmax = as.Date(end), ymin = -Inf, ymax = Inf),
            inherit.aes = FALSE, alpha = 0.5, fill = c("gray90")) + # see https://stackoverflow.com/questions/40331685/shading-month-intervals-when-plotting-time-series-data-with-different-start-and
  coord_cartesian(xlim = range(cohortData$Date %>% as.Date(.))) +
  geom_point(size = 1.05, alpha = 0.8, aes(colour = User)) +
  ggrepel::geom_text_repel(aes(label = label), # see: https://stackoverflow.com/questions/29357612/plot-labels-at-ends-of-lines
    alpha = 0.5,
    size = 2.5,
    box.padding = 0,
    nudge_x = 1,
    na.rm = TRUE) +
  scale_x_date(labels = scales::date_format("%d/%m"),
               date_minor_breaks = "1 day") +
  scale_y_continuous(breaks = seq(from = 0, to = 1000, by = 20)) + 
  scale_colour_viridis_d(end = 0.9) +
  labs(x = "Day", y = "Cumulative questionnaires answered") +
  theme_bw() +
  theme(legend.position = "none")

```


# How long have participants been in the study, and how much data have they gathered?

```{r}

# Total Questionnaires answered
cohortData %>% 
  dplyr::group_by(User, Date) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::group_by(User) %>% 
  dplyr::summarise("Questionnaires answered" = n()) 
  
# Number of unique days with answers
cohortData %>% 
  dplyr::filter(Field != "howami_participation_started") %>% 
  dplyr::mutate(Date = as.Date(Date)) %>% 
  dplyr::group_by(User, Date) %>% 
  dplyr::summarise("Number of questions answered" = n()) %>% 
  dplyr::group_by(User) %>% 
  dplyr::summarise("Number of days with answers" = n()) 

# Number of weeks in study
cohortData %>% 
  dplyr::filter(Field == "howami_participation_started") %>% 
  dplyr::select(User, Date) %>% 
  dplyr::mutate(Date = as.Date(Date),
                Today = Sys.Date(),
                Weeks = as.numeric(difftime(Today, Date, units="weeks")) %>% round(., 1)) %>%
  dplyr::select(User, Weeks) 


```

## Find values for a particular participant

```{r}
user <- "Moti26"

# Total Questionnaires answered
questionnaires <- cohortData %>% 
  dplyr::group_by(User, Date) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::group_by(User) %>% 
  dplyr::summarise("Questionnaires answered" = n()) %>% 
  dplyr::filter(User == user) %>% 
  dplyr::select(2)
  
# Number of unique days with answers
uniqueDays <- cohortData %>% 
  dplyr::filter(Field != "howami_participation_started") %>% 
  dplyr::mutate(Date = as.Date(Date)) %>% 
  dplyr::group_by(User, Date) %>% 
  dplyr::summarise("Number of questions answered" = n()) %>% 
  dplyr::group_by(User) %>% 
  dplyr::summarise("Number of days with answers" = n()) %>% 
  dplyr::filter(User == user) %>% 
  dplyr::select(2)

# Number of weeks in study
weeksInStudy <- cohortData %>% 
  dplyr::filter(Field == "howami_participation_started") %>% 
  dplyr::select(User, Date) %>% 
  dplyr::mutate(Date = as.Date(Date),
                Today = Sys.Date(),
                Weeks = as.numeric(difftime(Today, Date, units="weeks")) %>% round(., 1)) %>%
  dplyr::select(User, Weeks) %>% 
  dplyr::filter(User == user) %>% 
  dplyr::select(2)

data.frame(User = user, questionnaires, uniqueDays, weeksInStudy)

```
# Tasks

## Explore added tasks

```{r}

tasklist <- cohortData %>%
  dplyr::mutate(day = as.Date(Date)) %>% 
  tidyr::spread(Field, Value) %>%
  dplyr::select(task, User, day) %>% 
  dplyr::filter(str_detect(string = task, pattern = "added_")) %>% 
  dplyr::arrange(day, User)
tasklist$task <- gsub('added_', '', tasklist$task)
tasklist$task <- gsub('_', ' ', tasklist$task)
tasklist %>% 
  # distinct(task, .keep_all = TRUE) %>% 
  dplyr::filter(day > "2018-10-29") %>% 
  write.table(., sep = "\t", file = "clipboard", row.names = FALSE)

cohortData %>%
  # dplyr::select(User, Field, Value, Date) %>% 
  dplyr::filter(str_detect(string = User, pattern = "09"), Field == "task",
                # str_detect(string = Value, pattern = "added")
                ) 

cohortData %>%
  dplyr::select(User, Field, Value, Date) %>% 
  dplyr::filter(str_detect(string = Value, pattern = "added_"),
                str_detect(string = Value, pattern = "oman osaamisen")) 

```

## Check for popular and unpopular task options

```{r}
# Check for unused options: all these from the excel file:
taskOptions <- c("meet_internal", "meet_external", "report_write_comment", "create_content", "plan_work", "plan_projects", "tunnuslukujen_raportointi", "sisäinen_viestintä", "prepare_meeting", "arranging_meeting_time", "participating_course", "muutokset_lomakkeisiin", "read_report", "read_social_media", "project_planning", "project_preparation", "projektinhallinta", "email", "using_Teams", "research_google", "tilastojen_kokoaminen", "modify_statistics", "ahjo", "documentation", "informing_supervisors", "creating_presentation", "excel", "facilitation", "writing_memo", "meet_serviceprovider", "participating_training", "leading_training", "leading_course", "decision_preparation_support_ahjo", "mailing", "reporting_absences", "reporting_tva", "creating_recruitment_ad", "research_background", "participating_seminar", "leading_seminar", "data_interpretation", "office_work", "interview_job", "helping_colleague", "preparing_work_contracts", "modifying_work_environment", "developing_work_community", "preparatory_work", "error_correction_responselist", "participating_webinar", "leading_webinar", "scheduling", "supervisor_support_employment", "listening_to_presentation", "giving_presentation", "consulting_hr_manager", "hr_reporting", "employee_event", "wellbeing", "intranet_pages", "board_meeting", "summer_job", "writing_plan", "reporting_training_information", "course_handling", "statement", "negotiation", "negotiation_phone_call", "preparing_own_training", "salary_excel", "preparing_salary_decisions", "employment_issue", "phone_call", "questback_bills", "reporting_salary", "recruitment", "recruitment_offering_job", "miscellaneous", "planning_event", "pagination_planning", "organise_event", "team_meeting", "making_order", "Industry_meeting", "evaluating_job_demands", "work_ergonomics", "employer_image", "job_classification", "news", "coaching", "preparation", "response_rates", "response_rates_communicating", "video_lecture", "planning_recreation_day", "planning_webinar", "collective_bargaining", "meeting_unit", "canvas")

# get the used options
taskUsed <- cohortData %>%
  dplyr::mutate(day = as.Date(Date)) %>% 
  tidyr::spread(Field, Value) %>%
  dplyr::select(task, User, day) %>% 
  dplyr::pull(task)

# get the difference
setdiff(taskOptions, taskUsed)

# Find most popular non-self-added tasks:
cohortData %>%
  dplyr::mutate(day = as.Date(Date)) %>% 
  tidyr::spread(Field, Value) %>%
  dplyr::filter(!str_detect(string = task, pattern = "added_")) %>% 
  dplyr::select(task, User, day) %>%
  dplyr::group_by(task) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::arrange(desc(n)) %>% 
  write.table(., sep = "\t", file = "clipboard", row.names = FALSE)

# Find most popular self-added tasks:
cohortData %>%
  dplyr::mutate(day = as.Date(Date)) %>% 
  tidyr::spread(Field, Value) %>%
  dplyr::filter(str_detect(string = task, pattern = "added_")) %>% 
  dplyr::select(task, User, day) %>%
  dplyr::group_by(task) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::arrange(desc(n)) %>% 
  write.table(., sep = "\t", file = "clipboard", row.names = FALSE)
```


```{r}
esm_data %>% dplyr::filter(!is.na(task)) %>% 
  mutate(Task = reorder(task, task, FUN = length)
         # Task = forcats::fct_relevel(Task, "muu", after = Inf)
         ) %>% 
  dplyr::count(Task) %>% # essentially the same as dplyr::group_by(task) %>% dplyr::summarise(n = n())
  dplyr::mutate(fraction = n / sum(n),
                ymax = cumsum(fraction), # cumulative sum going down
                ymin = c(0, head(ymax, n = -1))) %>% # starting from the previous value, add the next 
  dplyr::arrange(desc(fraction)) %>% 
  ggplot(aes(fill = Task, ymax = ymax, ymin = ymin, xmax = 9, xmin = 5)) +
    geom_rect(colour = "grey30") +
    coord_polar(theta = "y") +
    xlim(c(0, 9)) +
    theme_bw() +
    theme(panel.grid = element_blank()) +
    theme(axis.text = element_blank()) +
    theme(axis.ticks = element_blank()) +
    # theme(legend.title = element_blank()) + # This works but makes the boxes too close to the items
    labs(x = NULL, y = NULL, title = NULL) +
    annotate("text", x = 0, y = 0, label = paste0("Vastauksia: ", esm_data$task %>% table() %>% sum())) +
    ggrepel::geom_label_repel(aes(label = paste(fraction %>% round(., 2) * 100, "%"), 
                                  x = 7, y = (ymin + ymax)/2),
                              inherit.aes = TRUE, 
                              show.legend = FALSE,
                              force = 0.01) +
    guides(fill = guide_legend(reverse = TRUE, title = "Tehtävä"))

```

# Motivation dot (and-line) charts

```{r}
# esm_data %>% tidyr::gather(muuttuja, arvo, Vapaaehtoisuus:Yhteenkuuluvuus) %>% 
#   dplyr::select(date, arvo, muuttuja) %>% 
#   na.omit() %>%
#   ggplot(aes(x = date, y = arvo, group = muuttuja, colour = muuttuja)) +
#   geom_smooth(span = 0.15, se = FALSE) +
#   # geom_point() +
#   labs(x = NULL) +
#   # geom_line(alpha = 0.3, size = 1.5) +
#   theme_bw()

# Marking outliers, from: https://stackoverflow.com/questions/33524669/labeling-outliers-of-boxplots-in-r
is_outlier <- function(x) {
  return(x < quantile(x, 0.25, na.rm = TRUE) - 1.5 * IQR(x, na.rm = TRUE) | x > quantile(x, 0.75, na.rm = TRUE) + 1.5 * IQR(x, na.rm = TRUE))
}

esm_data %>%
  dplyr::mutate(sisäinen = (sdt3 + sdt4 + sdt5) / 3,
                ulkoinen = (sdt1 + sdt2 + sdt6) / 3,
                outlier_ulkoinen = ifelse(is_outlier(ulkoinen), date, as.numeric(NA)),
                outlier_ulkoinen = format(as.Date(outlier_ulkoinen, origin = '1970-01-01'), format="%d/%m"),
                outlier_sisäinen = ifelse(is_outlier(sisäinen), date, as.numeric(NA)),
                outlier_sisäinen = format(as.Date(outlier_sisäinen, origin = '1970-01-01'), format="%d/%m")) %>% 
  # tidyr::gather(muuttuja, arvo, sisäinen:ulkoinen) %>%
  # dplyr::select(date, arvo, muuttuja, outlier_ulkoinen, outlier_sisäinen) %>%
  ggplot(aes(x = date, y = sisäinen)) +
  geom_smooth(aes(x = date, y = sisäinen), color = "red", span = 0.15, se = FALSE) +
  geom_point(alpha = 0.15, color = "red") +
  geom_smooth(aes(x = date, y = ulkoinen), span = 0.15, se = FALSE) +
  geom_point(aes(x = date, y = ulkoinen), color = "blue", alpha = 0.15) +
  labs(x = NULL, y = NULL, title = "Sisäinen (pun.) ja ulkoinen (sin.) motivaatio mittausjaksolla") +
  # geom_line(alpha = 0.3, size = 1.5) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 10)) +
  geom_text(aes(label = outlier_ulkoinen), hjust = -0.1) +
  geom_text(aes(label = outlier_sisäinen), hjust = -0.1) 

esm_data %>%
  tidyr::gather(muuttuja, arvo, sdt1:sdt6) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "sdt1") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "... Koska joku muu haluaa") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1) 

esm_data %>%
  tidyr::gather(muuttuja, arvo, sdt1:sdt6) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "sdt2") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "... Koska tilanne vaatii") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1) 

esm_data %>%
  tidyr::gather(muuttuja, arvo, sdt1:sdt6) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "sdt3") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "... Koska se on miellyttävää") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1) 

esm_data %>%
  tidyr::gather(muuttuja, arvo, sdt1:sdt6) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "sdt4") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "... Koska se on kiinnostavaa") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1) 

esm_data %>%
  tidyr::gather(muuttuja, arvo, sdt1:sdt6) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "sdt5") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "... Koska se on tärkeää minulle") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1) 

esm_data %>%
  tidyr::gather(muuttuja, arvo, sdt1:sdt6) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "sdt6") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "... Koska muuten tuntisin itseni syylliseksi tai ahdistuneeksi") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1) 
```

# Needs satisfaction: tasks

```{r}

# Marking outliers, from: https://stackoverflow.com/questions/33524669/labeling-outliers-of-boxplots-in-r

esm_data %>%  
  rowwise %>% 
  dplyr::mutate(Tarvetyydytys = ((Vapaaehtoisuus + Kyvykkyys + Yhteenkuuluvuus) / 3),
                Olinpaikka = factor(Location),
                `Muita paikalla` = social) %>% 
  dplyr::group_by(task) %>%
  dplyr::filter(!is.na(Tarvetyydytys)) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(Tarvetyydytys), Tarvetyydytys, as.numeric(NA))) %>% 
  dplyr::filter(n() > 5) %>% # Retain only tasks with more than 5 observations
  ggplot(aes(x = task, y = Tarvetyydytys)) +
  # geom_boxplot() +
  geom_point(aes(size = `Muita paikalla`, color = Olinpaikka), position = position_jitter(w = 0.2, h = 0)) +
  # geom_jitter(width = 0.2) +
  ylim(c(0, 7)) +
  labs(title = "Psykologisten perustarpeiden tyydyttyminen yleisimmissä tehtävissä", 
       x = NULL,
       y = "Perustarpeiden keskiarvo") +
  theme_bw() 
  

```
 
# Needs satisfaction: time

```{r}
esm_data %>%
  tidyr::gather(muuttuja, arvo, Vapaaehtoisuus:Yhteenkuuluvuus) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "Vapaaehtoisuus") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "Vapaaehtoisuus") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1)

esm_data %>%
  tidyr::gather(muuttuja, arvo, Vapaaehtoisuus:Yhteenkuuluvuus) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "Kyvykkyys") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "Kyvykkyys") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1, vjust = 0.1, angle = 315, size = 2)

esm_data %>%
  tidyr::gather(muuttuja, arvo, Vapaaehtoisuus:Yhteenkuuluvuus) %>%
  dplyr::mutate(outlier = ifelse(is_outlier(arvo), date, as.numeric(NA)),
                outlier = format(as.Date(outlier, origin = '1970-01-01'), format="%d/%m")) %>% 
  dplyr::filter(muuttuja == "Yhteenkuuluvuus") %>% 
  ggplot(aes(x = date, y = arvo)) +
  geom_point(aes(x = date, y = arvo, size = `Muita paikalla`, color = Olinpaikka), 
             position = position_jitter(w = 0.15, h = 0.15), 
             alpha = 0.8) +
  scale_x_date(date_labels="%d/%m", date_breaks  ="1 day") +
  theme_bw() +
  labs(x = NULL, y = NULL, title = "Yhteenkuuluvuus") +
  theme(axis.text.x=element_text(angle = 270, hjust = 0),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(1, 7)) +
  geom_text(aes(label = outlier), hjust = -0.1)
```

# Pirate plot

```{r}

esm_data %>%  
  rowwise %>% 
  dplyr::mutate(Tarvetyydytys = ((Vapaaehtoisuus + Kyvykkyys + Yhteenkuuluvuus) / 3)) %>% 
  dplyr::group_by(task) %>%
  dplyr::filter(!is.na(Tarvetyydytys)) %>% 
  dplyr::filter(n() > 5) %>% # Retain only tasks with more than 5 observations
yarrr::pirateplot(
  formula = Tarvetyydytys ~ task, # dv is weight, iv is Diet
  data = .,
  theme = 0,
  pal = "southpark", # southpark color palette
  bean.f.o = .25, # Bean fill
  point.o = .3, # Points
  inf.f.o = .7, # Inference fill
  inf.b.o = .8, # Inference border
  avg.line.o = 1, # Average line
  bar.f.o = .0, # Bar
  inf.f.col = "white", # Inf fill col
  inf.b.col = "black", # Inf border col
  avg.line.col = "black", # avg line col
  # bar.f.col = gray(.8), # bar filling color
  point.pch = 21,
  point.bg = "white",
  point.col = "black",
  point.cex = .7,
  decreasing = TRUE,
  main = "Tarvetyydytys yleisimmissä tehtävissä",
  xlab = "",
  ylab = "Psykologinen tarvetyydytys",
  # xaxt = "n",
  sortx = "mean",
  ylim = c(0, 7))
```

# TNO SDT data

## Distributions 

```{r}
tnoData %>%
  dplyr::filter(User == username) %>% 
  dplyr::filter(!is.na(Value)) %>% 
  ggplot2::ggplot(aes(y = forcats::fct_rev(Field))) +
  ggridges::geom_density_ridges2(
    aes(x = Value, colour = "black", 
        fill = Field,
        point_color = Field,
        point_fill = Field,
        point_shape = Field),
    scale = .75, alpha = 0.6, size = 0.25,
    position = position_raincloud(width = 0.05, height = 0.15),
    from = 0, to = 50,
    jittered_points = TRUE,
    point_size = 1) +
  labs(
    title = "Vastausten jakaumat", 
    x = NULL,
    y = NULL) +
  scale_y_discrete(expand = c(0.1, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
      # labels = c('Autonomous motivation T1 MVPA accelerometer' = "T1 MVPA accelerometer",
      #            'Autonomous motivation T1 MVPA questionnaire' = "T1 MVPA questionnaire"),
      values = viridis::viridis(12, end = 1, direction = -1),
      name = ""
      # guide = guide_legend(override.aes = list(alpha = 1,
      #                                          point_shape = c(3, 4),
      #                                          point_size = 2))
      ) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(12, end = 1, direction = -1),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(12, end = 1, direction = -1),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = rep(4, 12),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

```

## Correlations

```{r}
# Create a covariance matrix of the data
covMatrix <- sdtData %>% 
  tidyr::spread(Field, Value) %>% 
  dplyr::select(Kyvykkyys:`Joku toinen`) %>% 
  cov(use = "pairwise.complete.obs")

# Transform the matrix so, that lower diagonal of the matrix shows partial correlations,
# while the upper one shows bivariate correlations.
matrix_corLower_parcorUpper <- covMatrix %>% ggm::correlations()

matrix_corLower_parcorUpper %>% 
  corrgram::corrgram(
  type = "cor",
  lower.panel = corrgram::panel.pie,
  upper.panel = corrgram::panel.pie,
  # order = TRUE,
  # outer.labels = list(bottom = list(labels = colnames(covMatrix), cex = 0.75, srt = 30),
  #                     left = list(labels = colnames(covMatrix), cex = 0.75, srt = 30)),
  # labels = colnames(covMatrix),
  main = "Bivariate (upper diagonal) and partial (lower diagonal)\ncorrelations")

```

## Time series line plots

```{r}
sdtData %>% 
  dplyr::filter(Field == "Kyvykkyys" | Field == "Vapaaehtoisuus" | Field == "Yhteenkuuluvuus") %>% 
ggplot(aes(x = Date, y = Value, colour = Field)) +
  geom_line() +
  geom_point(size = .75) +
  facet_wrap( ~ Field, ncol = 1) +
  scale_y_continuous(breaks = seq(0, 50, by = 50)) +
  labs(x = NULL, y = NULL) +
  theme_bw() +
  theme(
    # strip.background = element_blank(),
    # strip.text.x = element_blank(),
    # strip.text.y = element_blank(),
    # axis.text.y = element_text(), 
    # axis.title.y = element_blank(),
    legend.position="none"
    ) 

```

# Networks

```{r}

sdtVarData <- allData %>%
  dplyr::select(Vapaaehtoisuus, Kyvykkyys, Yhteenkuuluvuus, Date, day) %>% 
  dplyr::arrange(Date) %>% 
  dplyr::group_by(day) %>% 
  dplyr::mutate(beep = row_number()) %>% # Running number for beeps within days
  dplyr::ungroup() %>% 
  na.omit(.)

df <- sdtVarData$Date
time_01 <- df - df[1]
time_01 <- as.numeric(time_01)
time_01 <- time_01 / max(time_01) # normalise time, not necessary for mgm, though

days <- sdtVarData$day
beeps <- sdtVarData$beep

sdtVarData_values <- sdtVarData %>% 
  dplyr::select(-Date, -beep, -day) %>% 
  mutate_all(funs(as.numeric(.)))

bwSeq <- seq(0.01, 1, length = 10) # ten equally spaced values in [0:01; 1]

# Find optimal bandwidth
bw_object <- mgm::bwSelect(data = sdtVarData_values,
  type = rep("g", 3),
  level = rep(1, 3),
  bwSeq = bwSeq,
  bwFolds = 1,
  bwFoldsize = 20,
  modeltype = "mvar",
  lags = 1,
  scale = TRUE,
  timepoints = time_01,
  dayvar = days,
  beepvar = beeps,
  pbar = TRUE)

bandwidth <- bwSeq[which.min(bw_object$meanError)]

data.frame(bwSeq, bw_object$meanError) %>% plot()

set.seed(1)
tvvar_obj <- mgm::tvmvar(data = sdtVarData_values,
  type = rep("g", 3),
  level = rep(1, 3),
  lambdaSel = "CV",
  timepoints = time_01,
  estpoints = seq(0, 1, length = round(nrow(sdtVarData_values) / 7, 0)), # One point per week
  bandwidth = bandwidth,
  dayvar = days,
  beepvar = beeps,
  lags = 1,
  scale = TRUE)

tvvar_obj

# res_obj <- mgm::resample(object = tvvar_obj,
#   data = sdtVarData_values,
#   nB = 50,
#   blocks = 10,
#   seeds = 1:50,
#   quantiles = c(.05, .95))

pred_obj <- predict(object = tvvar_obj,
  data = sdtVarData_values,
  errorCon = c("R2", "RMSE"),
  tvMethod = "weighted",
  consec = beeps)

# pred_obj$errors
# pred_obj$tverrors

# Get layout of mean graph
mean_wadj <- apply(tvvar_obj$wadj[, , 1, ], 1:2, mean)
Q <- qgraph::qgraph(t(mean_wadj), DoNotPlot=TRUE)
saveRDS(Q$layout, "layout_mgm.RDS")

# Plot graph at selected fixed time points
tpSelect <- 1:round(nrow(sdtVarData_values) / 7, 0)

for(tp in tpSelect) {
  qgraph::qgraph(t(tvvar_obj$wadj[, , 1, tp]), 
         layout = Q$layout,
         edge.color = t(tvvar_obj$edgecolor[, , 1, tp]),
         vsize = 13, 
         esize = 10,
         asize = 10, 
         mar = c(12, 12, 12, 12), 
         minimum = 0, 
         maximum = .45,
         labels = c("Autonomy", "Competence", "Relatedness"),
         # label.scale = FALSE,
         color = viridis::viridis(3, begin = 0.7),
         pie = pred_obj$tverrors[[tp]][, 3],
         title = paste0("Week no. ", tp))
}


# Fully connected dummy model; "this is what the theory says"
qgraph::qgraph(matrix(rep(c(1,1,1), 3), nrow = 3), 
  layout = Q$layout,
  edge.color = "darkgreen", 
  vsize = 13, 
  esize = 10,
  asize = 10, 
  mar = c(10, 10, 10, 10),
  minimum = 0, 
  maximum = .45,
  labels = c("Autonomy", "Competence", "Relatedness"),
  # label.scale = FALSE,
  color = viridis::viridis(3, begin = 0.7),
 pie = pred_obj$tverrors[[tp]][, 3])

```

## Stationary network with mgm

```{r}

set.seed(1)
mvar_obj <- mgm::mvar(data = sdtVarData_values,
  type = rep("g", 3),
  level = rep(1, 3),
  lambdaSel = "CV",
  # dayvar = days,
  # beepvar = beeps,
  lags = c(1, 2, 3),
  scale = TRUE)

mvar_obj

mvar_pred_obj <- predict(object = mvar_obj,
  data = sdtVarData_values,
  errorCon = c("R2", "RMSE"),
  tvMethod = "weighted",
  consec = beeps)

# Plot graph at selected fixed time points
tpSelect <- c(1, 2, 3)

for(tp in tpSelect) {
  qgraph::qgraph(t(mvar_obj$wadj[, , tp]), 
         layout = "spring",
         edge.color = t(mvar_obj$edgecolor[, , 1]),
         vsize = 13, 
         esize = 10,
         asize = 10, 
         mar = c(12, 12, 12, 12), 
         minimum = 0, 
         maximum = .45,
         labels = c("Autonomy", "Competence", "Relatedness"),
         # label.scale = FALSE,
         color = viridis::viridis(3, begin = 0.7),
         pie = mvar_pred_obj$errors[, 3])
}

mvar_pred_obj$errors[[1]]
```


## Contemporaneous and stationary network with graphicalVAR

```{r}
Results <- graphicalVAR::graphicalVAR(sdtVarData_values, vars = names(sdtVarData_values), gamma = 0)

vars <- stringr::str_replace(vars, "_", " ")

sdtVarData2 <- sdtData %>% 
  tidyr::spread(Field, Value) %>% 
  dplyr::rename(Joku_toinen = `Joku toinen`)

vars2 <- sdtVarData2 %>% select(Kyvykkyys:ncol(sdtVarData2)) %>% names()

Results2 <- graphicalVAR::graphicalVAR(sdtVarData2, vars = vars2, gamma = 0)

# vars <- c("Autonomy", "Relatedness", "Competence", "Interest or pleasure", "It is important", "Avoid guilt", "Situation requires", "Someone else wants")
qgraph::qgraph(Results$PCC,
               layout = "spring",
               repulsion = 0.99,
               label.scale = FALSE,
               # pie = piefill,
               # pieBorder = 1,
               # pieColor = piecolors,
               labels = names(sdtVarData_values),
               label.cex = 1.25)

qgraph::qgraph(Results$PDC,
               layout = "spring",
               label.scale = FALSE, 
               labels = names(sdtVarData_values))

```

```{r}

# fit_mvar <- mvar(data = sdtVarData,
#   type = rep("g", 9),
#   level = rep(1, 9),
#   lambdaSel = "EBIC",
#   lambdaGam = .25,
#   lags = c(1, 2, 3, 4))


# qgraph::qgraph(t(fit_mvar$wadj[, , 1]),
#   edge.color = t(fit_mvar$edgecolor[, , 1]),
#   nodeNames = names(sdtVarData))

########## Combine pleasure and interest

# sdtVarData <- sdtData %>% 
#   tidyr::spread(Field, Value) %>% 
#   dplyr::rename(Joku_toinen = `Joku toinen`) %>% 
#   dplyr::select(-Kiinnostus, -Mielihyvä)

sdtVarData <- allData %>%
  dplyr::filter(!is.na(Value)) %>%
  tidyr::spread(Field, Value) %>% 
  dplyr::rename(Joku_toinen = `Joku toinen`) %>% 
  dplyr::mutate(Kiinnostus_Mielihyvä = ((Kiinnostus + Mielihyvä) / 2)) %>%
  dplyr::arrange(Date) %>% 
  dplyr::select(-Perustarpeet, -"Sisäinen motivaatio", -"Ulkoinen motivaatio", 
                -Kiinnostus, -Mielihyvä,
                -User, -Serie, -day, -Date) %>% 
  dplyr::select(Vapaaehtoisuus, Yhteenkuuluvuus, Kyvykkyys,
                Kiinnostus_Mielihyvä, Tärkeys,
                Syyllisyys, Tilanne, Joku_toinen)

# vars <- sdtVarData %>% select(Kyvykkyys:ncol(sdtVarData)) %>% names()
vars <- names(sdtVarData)

# piefill <- sdtVarData %>% summarise_at(vars(Kyvykkyys:ncol(sdtVarData)), funs(mean(.) / 50))
piefill <- sdtVarData %>% summarise_all(funs(mean(.) / 50))

piecolors <- c(rep(viridis::viridis(3, begin = 0.5, end = 0.99)[3], 3),
               rep(viridis::viridis(3, begin = 0.5, end = 0.99)[2], 2),
               rep(viridis::viridis(3, begin = 0.5, end = 0.99)[1], 3))
  
Results <- graphicalVAR::graphicalVAR(sdtVarData, vars = vars, gamma = 0)

vars <- stringr::str_replace(vars, "_", " ")

sdtVarData2 <- sdtData %>% 
  tidyr::spread(Field, Value) %>% 
  dplyr::rename(Joku_toinen = `Joku toinen`)

vars2 <- sdtVarData2 %>% select(Kyvykkyys:ncol(sdtVarData2)) %>% names()

Results2 <- graphicalVAR::graphicalVAR(sdtVarData2, vars = vars2, gamma = 0)

# vars <- c("Autonomy", "Relatedness", "Competence", "Interest or pleasure", "It is important", "Avoid guilt", "Situation requires", "Someone else wants")
qgraph::qgraph(Results$PCC,
               layout = "spring",
               repulsion = 0.99,
               label.scale = FALSE,
               pie = piefill,
               pieBorder = 1,
               pieColor = piecolors,
               labels = vars,
               label.cex = 1.25)

qgraph::qgraph(Results$PDC,
               layout = "spring",
               label.scale = FALSE, 
               labels = vars)


qgraph::qgraph(Results2$PCC,
               layout = "spring",
               label.scale = FALSE, 
               labels = vars2,
               title = "Kiinnostus ja mielihyvä erikseen")
table(allData$Field)
```

```{r}
cohortData %>% 
  dplyr::filter(User == "Moti09") %>% 
  tidyr::spread(Field, Value)
```

## Contemporaneous time-varying network with mgm

```{r}
sdtVarData <- tnoData %>% 
  dplyr::filter(User == "Moti05") 

readr::write_rds(sdtVarData, path  = "sdtVarData.RDS")
readr::write_rds(sdtVarData_values, path  = "sdtVarData_values.RDS")
readr::write_rds(time_01, path  = "time_01.RDS")
readr::write_rds(bw_object, path  = "bw_object.RDS")
readr::write_rds(tvvar_obj, path  = "tvvar_obj.RDS")

library(tidyverse)

sdtVarData <- readr::read_rds("sdtVarData.RDS")

sdtVarData <- sdtVarData %>% 
  tidyr::spread(Field, Value) %>%
  dplyr::select(autonomy, competence, relatedness, Date) %>% 
  dplyr::arrange(Date) %>% 
  na.omit(.)

df <- sdtVarData$Date
time_01 <- df - df[1]
time_01 <- as.numeric(time_01)
time_01 <- time_01 / max(time_01) # normalise time, not necessary for mgm, though

days <- sdtVarData$day
beeps <- sdtVarData$beep

sdtVarData_values <- sdtVarData %>% 
  dplyr::select(-Date) %>% 
  dplyr::mutate_all(funs(as.numeric(.)))

bwSeq <- seq(0.01, 1, length = 10) # ten equally spaced values in [0:01; 1]

# Find optimal bandwidth
bw_object <- mgm::bwSelect(data = sdtVarData_values,
  type = rep("g", 3),
  level = rep(1, 3),
  bwSeq = bwSeq,
  bwFolds = 2,
  bwFoldsize = 20,
  modeltype = "mvar",
  lags = 1,
  scale = TRUE,
  timepoints = time_01)

bandwidth <- bwSeq[which.min(bw_object$meanError)]

data.frame(bwSeq, bw_object$meanError) %>% plot()

# --------- Fit time-varying VAR -----------------------------------

estpoints <- seq(from = 0, to = 1, length = 50)

set.seed(1)
tvvar_obj <- mgm::tvmvar(data = sdtVarData_values,
  type = rep("g", 3),
  level = rep(1, 3),
  lambdaSel = "CV",
  timepoints = time_01,
  estpoints = estpoints, 
  bandwidth = bandwidth,
  lags = 1,
  saveData = TRUE,
  scale = TRUE)

tvvar_obj
sdtVarData_values_datamatrix <- data.matrix(sdtVarData_values)

pred_obj <- predict(object = tvvar_obj,
  data = sdtVarData_values,
  tvMethod = "weighted")

residuals <- pred_obj$true - pred_obj$predicted

# pred_obj$errors
# pred_obj$tverrors

resample_obj <- mgm::resample(object = tvvar_obj,
  data = sdtVarData_values,
  nB = 50,
  blocks = 10,
  seeds = 1:50,
  quantiles = c(.05, .95))

readr::write_rds(resample_obj, path = paste0("rds_files/resample_obj_", username, ".RDS"))

# --------- Fit time-varying MGM on Residuals ----------------------

set.seed(1)
tv_mgm_contemporaneous <- mgm::tvmgm(data = residuals, 
                    type = rep("g", 3), 
                    level = rep(1, 3), 
                    lambdaSel = "CV", 
                    bandwidth = bandwidth,
                    estpoints = estpoints)

readr::write_rds(tv_mgm_contemporaneous, path = paste0("rds_files/tv_mgm_contemporaneous_", username, ".RDS"))


# --------- Look at Variance over time ---------------------------------------------

# Use weighting from model

data_design <- pred_obj$true
m_means <- m_sd <- matrix(NA, nrow = 20, ncol=33)

for(i in 1:20) {
  for(v in 1:p) {
    
    # get weights from model
    w_i <- tv_var_p33$tvmodels[[i]]$call$weights_design
    
    # compute weighted mean
    m_means[i, v] <- sum(data_design[, v]*w_i) / sum(w_i)
    
    # compute weighted variance
    V1 <- sum(w_i)
    V2 <- sum(w_i^2)
    m_sd[i, v] <-  sum(w_i * (data_design[, v] - m_means[i, v])^2) * V1 / (V1^2 - V2)
    
  }
}


# plot.new()
# plot.window(xlim=c(1, 20), ylim=c(0, 2))
# for(v in 1:33) lines(m_sd[, v])
# axis(1, c(1, 10, 20))
# axis(2, c(0, 1, 2), las=2)
# title(xlab="Time")
# title(ylab="SD", las=2)
# title(main="Smooted SD over time")

# Find out roughly how many weeks they've been measured on, to later show results per week
weeks <- lubridate::yday(sdtVarData$Date) %>%
  tibble::as.tibble() %>%
  count(value) %>%
  nrow() / 5
weeks <- round(weeks, 0)

# Get layout of mean graph
mean_wadj <- apply(tv_mgm_contemporaneous$wadj[, , 1, ], 1:2, mean)
Q <- qgraph::qgraph(t(mean_wadj), DoNotPlot=TRUE)
saveRDS(Q$layout, "layout_mgm.RDS")

# Plot graph at selected fixed time points
tpSelect <- seq(from = 5, to = length(estpoints) - 5, by = ceiling(length(estpoints) / weeks))

for(tp in tpSelect) {
  qgraph::qgraph(t(tvvar_obj$wadj[, , 1, tp]), 
         layout = Q$layout,
         edge.color = t(tvvar_obj$edgecolor[, , 1, tp]),
         vsize = 13, 
         esize = 10,
         asize = 10, 
         mar = c(12, 12, 12, 12), 
         minimum = 0, 
         maximum = .45,
         labels = c("Autonomy", "Competence", "Relatedness"),
         # label.scale = FALSE,
         color = viridis::viridis(3, begin = 0.7),
         pie = pred_obj$tverrors[[tp]][, 3],
         title = paste0("Week no. ", tp))
}

for(tp in tpSelect) {
  qgraph::qgraph(t(tv_mgm_contemporaneous$wadj[, , 1, tp]), 
         layout = Q$layout,
         edge.color = t(tvvar_obj$edgecolor[, , 1, tp]),
         vsize = 13, 
         esize = 10,
         asize = 10, 
         mar = c(12, 12, 12, 12), 
         minimum = 0, 
         maximum = .45,
         labels = c("Autonomy", "Competence", "Relatedness"),
         # label.scale = FALSE,
         color = viridis::viridis(3, begin = 0.7),
         pie = pred_obj$tverrors[[tp]][, 3],
         title = paste0("Week no. ", tp))
}

# Fully connected dummy model; "this is what the theory says"
qgraph::qgraph(matrix(rep(c(1,1,1), 3), nrow = 3), 
  layout = Q$layout,
  edge.color = "darkgreen", 
  vsize = 13, 
  esize = 10,
  asize = 10, 
  mar = c(10, 10, 10, 10),
  minimum = 0, 
  maximum = .45,
  labels = c("Autonomy", "Competence", "Relatedness"),
  # label.scale = FALSE,
  color = viridis::viridis(3, begin = 0.7),
 pie = pred_obj$tverrors[[tp]][, 3])

pred_obj$true
```


# Recurrence plots

```{r}
recurrenceData <- cohortData %>%
  dplyr::filter(!is.na(Value)) %>% 
  tidyr::spread(Field, Value) %>% 
  dplyr::arrange(Date) %>% 
  dplyr::mutate_at(vars(anxiety_guilt, autonomy, competence, for_others, importance, interest, own_question, pleasure, 
                        productivity_work, satisfaction_work, sleep_quality,
                        relatedness, required, time_since_break), 
                   funs(as.numeric)) %>% 
  dplyr::mutate_at(vars(location, others_task, project_name, task), funs(forcats::as_factor)) %>%
  dplyr::mutate(day = as.Date(Date)) %>% 
  dplyr::group_by(day, User) %>% 
  summarise_if(is.numeric, mean, na.rm = TRUE) %>% 
  dplyr::group_by(User) %>% 
  tidyr::nest()


for (i in 1:13){
  variable <- data.matrix(recurrenceData[i])
  recurrence_matrix_motivation <- casnet::rp(y1 = variable, 
                                          y2 = variable, 
                                          emDim = 1, 
                                          emLag = 1)

# recurrence_matrix_motivation <- casnet::di2bi(recurrence_matrix_motivation, emRad = 1)

recurrence_plot_motivation <- casnet::rp_plot(recurrence_matrix_motivation, 
                                              plotDimensions = TRUE, 
                                              returnOnlyObject = TRUE,
                                              # plotMeasures = TRUE,
                                              # radiusValue = NA,
                                              # plotSurrogate = "RS", # Doesn't seem to do anything yet
                                              xlab = colnames(variable),
                                              ylab = colnames(variable))

plot(recurrence_plot_motivation)
}

#### ESTIMATE RADIUS AND SHOW RQA MEASURES
for (i in c(11)) {
variable <- data.matrix(recurrenceData[i])
 
recurrence_matrix_motivation <- casnet::rp(y1 = variable, 
                                          y2 = variable, 
                                          emDim = 1, 
                                          emLag = 1)

recurrence_plot_motivation <- casnet::rp_plot(recurrence_matrix_motivation, 
                                              plotDimensions = TRUE, 
                                              returnOnlyObject = TRUE,
                                              # plotMeasures = TRUE,
                                              # radiusValue = NA,
                                              # plotSurrogate = "RS", # Doesn't seem to do anything yet
                                              xlab = colnames(variable),
                                              ylab = colnames(variable))

plot(recurrence_plot_motivation)

radius <- crqa_radius(RM = recurrence_matrix_motivation,
            y1 = variable,
            y2 = variable,
            type = "fixed")

recurrence_matrix_motivation_binary <- casnet::di2bi(recurrence_matrix_motivation, emRad = radius$Radius)

rqa_measures <- crqa_rp(RM = recurrence_matrix_motivation_binary, emRad = radius$Radius)

# recurrence_rate <- c()
# recurrence_rate[i] <- rqa_measures$RR
# 
# determinism <- c()
# determinism[i] <- rqa_measures$DET
# 
# entropy_diagonal <- c()
# entropy_diagonal[i] <- rqa_measures$ENT_dl

recurrence_plot_motivation_binary <- casnet::rp_plot(recurrence_matrix_motivation_binary, 
                                              plotDimensions = TRUE, 
                                              returnOnlyObject = TRUE,
                                              # plotMeasures = TRUE,
                                              # radiusValue = radius$Radius,
                                              # plotSurrogate = "RS", # Doesn't seem to do anything yet
                                              xlab = colnames(variable),
                                              ylab = colnames(variable))

plot(recurrence_plot_motivation_binary)
}

sisäinen <- rqa_measures
ulkoinen <- rqa_measures
perustarpeet <- rqa_measures

rbind(sisäinen, ulkoinen, perustarpeet)



```

```{r}
 
recurrence_matrix_motivation <- casnet::rp(y1 = recurrenceData$`Yhteenkuuluvuus`, 
                                          y2 = recurrenceData$`Kyvykkyys`, 
                                          emDim = 1, 
                                          emLag = 1)

recurrence_plot_motivation <- casnet::rp_plot(recurrence_matrix_motivation, 
                                              plotDimensions = TRUE, 
                                              returnOnlyObject = FALSE
                                              # plotMeasures = TRUE,
                                              # radiusValue = NA,
                                              # plotSurrogate = "RS", # Doesn't seem to do anything yet
                                              # xlab = "Intrinsic motivation",
                                              # ylab = "Intrinsic motivation"
                                              )

plot(recurrence_plot_motivation)

radius <- casnet::crqa_radius(RM = recurrence_matrix_motivation,
            y1 = NULL,
            y2 = recurrenceData$`Ulkoinen motivaatio`,
            type = "fixed")

recurrence_matrix_motivation_binary <- casnet::di2bi(recurrence_matrix_motivation, emRad = radius$Radius)

rqa_measures <- crqa_rp(RM = recurrence_matrix_motivation_binary, emRad = radius$Radius)

# recurrence_rate <- c()
# recurrence_rate[i] <- rqa_measures$RR
# 
# determinism <- c()
# determinism[i] <- rqa_measures$DET
# 
# entropy_diagonal <- c()
# entropy_diagonal[i] <- rqa_measures$ENT_dl

recurrence_plot_motivation_binary <- casnet::rp_plot(recurrence_matrix_motivation_binary, 
                                              plotDimensions = TRUE, 
                                              returnOnlyObject = TRUE,
                                              # plotMeasures = TRUE,
                                              # radiusValue = radius$Radius,
                                              # plotSurrogate = "RS", # Doesn't seem to do anything yet
                                              xlab = "Intrinsic motivation",
                                              ylab = "Extrinsic motivation"
                                              )

plot(recurrence_plot_motivation_binary)
```

### RQA on surveys answered

```{r rqa-surveys}

# Sys.setlocale("LC_ALL", "English") # For English month names
dateRanges <- data.frame(
  start = seq(as.POSIXct("1900-11-02 19:00:00"), as.POSIXct("2100-11-02 19:00:00"), "1 week"),
  startDay = weekdays(dateRanges$start),
  end = seq(as.POSIXct("1900-11-05 05:00:00"), as.POSIXct("2100-11-05 05:00:00"), "1 week"),
  endDay = weekdays(dateRanges$end)
)

df <- tnoData %>% 
  # dplyr::filter(Field != "howami_participation_started") %>%  # delete the rows which just indicate starting date
  tidyr::spread(Field, Value) %>%
  dplyr::mutate(day = as.Date(Date)) %>% 
  dplyr::group_by(day, User) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::arrange(day) %>% 
  dplyr::group_by(User) %>% 
  tidyr::nest()

# Add columns for recurrence plots
df <- df %>%
  dplyr::mutate(
    recurrence_matrix = purrr::map(data, ~casnet::rp(y1 = data.matrix(.)[, 'n'], 
                                                                   y2 = data.matrix(.)[, 'n'], 
                                                                   emDim = 1, emLag = 1)),
    # recurrence_matrix_motivation_am = purrr::map(recurrence_matrix_motivation_am, ~casnet::di2bi(., emRad = 1)),
    recurrence_plot = purrr::map(recurrence_matrix, ~casnet::rp_plot(., plotDimensions = TRUE, returnOnlyObject = TRUE))
    )

df <- df %>%
  dplyr::mutate(
    recurrence_matrix_happiness_pm = purrr::map(data, ~casnet::rp(y1 = data.matrix(.)[, 'happiness_pm'], 
                                                                   y2 = data.matrix(.)[, 'happiness_pm'], 
                                                                   emDim = 1, emLag = 1)),
    recurrence_matrix_happiness_pm = purrr::map(recurrence_matrix_happiness_pm, ~casnet::di2bi(., emRad = 1)),
    recurrence_plot_happiness_pm = purrr::map(recurrence_matrix_happiness_pm, ~casnet::rp_plot(., plotDimensions = TRUE, returnOnlyObject = TRUE))
    )

for(i in 1:nrow(df)){
  plot(df$recurrence_plot[[i]])
}

for(i in 1:11){
  plot(df$recurrence_plot_happiness_pm[[i]])
}

```

